name: Jira Workflow
on:
  pull_request:
    types: [opened, reopened, closed]
  issues:
    types: [opened, closed, reopened]

jobs:
  create-issue:
    name: Sync with Jira
    runs-on: ubuntu-latest
    steps:
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: Extract Jira Issue Key
        id: extract-key
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TITLE="${{ github.event.pull_request.title }}"
          else
            TITLE="${{ github.event.issue.title }}"
          fi
          JIRA_KEY=$(echo "$TITLE" | grep -oE '[A-Z]+-[0-9]+' || echo "")
          echo "JIRA_KEY=$JIRA_KEY" >> $GITHUB_ENV

      # Issue or PR opened -> Move to In Progress
      - name: Move to In Progress
        if: |
          env.JIRA_KEY != '' && 
          (github.event.action == 'opened' || github.event.action == 'reopened')
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ env.JIRA_KEY }}
          transition: "In Progress"

      # PR merged -> Move to Code Review
      - name: Move to Code Review
        if: |
          env.JIRA_KEY != '' && 
          github.event_name == 'pull_request' && 
          github.event.pull_request.merged == true
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ env.JIRA_KEY }}
          transition: "Code Review"

      # Issue closed -> Move to Done
      - name: Move to Done
        if: |
          env.JIRA_KEY != '' && 
          github.event.action == 'closed'
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ env.JIRA_KEY }}
          transition: "Done"

      # Add comment on Jira when PR is created
      - name: Comment on Jira (PR Created)
        if: |
          env.JIRA_KEY != '' && 
          github.event_name == 'pull_request' && 
          github.event.action == 'opened'
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ env.JIRA_KEY }}
          comment: |
            Pull Request created: [${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})
            Author: ${{ github.event.pull_request.user.login }}

      # Add comment on Jira when PR is merged
      - name: Comment on Jira (PR Merged)
        if: |
          env.JIRA_KEY != '' && 
          github.event_name == 'pull_request' && 
          github.event.pull_request.merged == true
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ env.JIRA_KEY }}
          comment: |
            Pull Request merged: [${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})
            Merged by: ${{ github.event.pull_request.merged_by.login }}\